"use strict";var f=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var k=(h,l)=>{for(var t in l)f(h,t,{get:l[t],enumerable:!0})},S=(h,l,t,n)=>{if(l&&typeof l=="object"||typeof l=="function")for(let e of v(l))!w.call(h,e)&&e!==t&&f(h,e,{get:()=>l[e],enumerable:!(n=b(l,e))||n.enumerable});return h};var F=h=>S(f({},"__esModule",{value:!0}),h);var M={};k(M,{default:()=>p});module.exports=F(M);var u=require("obsidian");function $(h,l){let t=h.toLowerCase().split(""),n=l.toLowerCase(),e=0;for(let i of t){let s=n.indexOf(i,e);if(s===-1)return!1;e=s+1}return!0}var p=class extends u.Plugin{constructor(){super(...arguments);this.index=new Map;this.isIndexing=!1}normalizeText(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^\p{L}\p{N}]/gu,"")}async deleteFromIndex(t){for(let[n,e]of this.index.entries()){let i=e.filter(s=>s.notePath!==t.path);i.length>0?this.index.set(n,i):this.index.delete(n)}}renameInIndex(t,n){for(let[e,i]of this.index.entries()){let s=i.map(r=>r.notePath===n?{...r,notePath:t.path,noteTitle:t.basename}:r);this.index.set(e,s)}}async onload(){this.metadataCache=this.app.metadataCache,this.vault=this.app.vault,await this.buildFullIndex(),this.registerEvent(this.metadataCache.on("changed",t=>this.debouncedIndexUpdate(t))),this.registerEvent(this.vault.on("create",t=>{t instanceof u.TFile&&this.debouncedIndexUpdate(t)})),this.registerEvent(this.vault.on("delete",t=>{t instanceof u.TFile&&this.deleteFromIndex(t)})),this.registerEvent(this.vault.on("rename",(t,n)=>{t instanceof u.TFile&&this.renameInIndex(t,n)})),this.registerEditorSuggest(new I(this))}async buildFullIndex(){if(this.isIndexing)return;this.isIndexing=!0,this.index.clear();let t=this.vault.getMarkdownFiles();for(let n of t)await this.indexFile(n);this.isIndexing=!1}async indexFile(t){if(t.extension!=="md")return;let n=t.basename,e=t.path;this.addToIndex(n,{type:"title",notePath:e,noteTitle:n,target:n,displayText:n});let i=this.metadataCache.getFileCache(t);i?.frontmatter?.tags&&(Array.isArray(i.frontmatter.tags)?i.frontmatter.tags:i.frontmatter.tags.split(",").map(r=>r.trim())).forEach(r=>{this.addToIndex(r,{type:"tag",notePath:e,noteTitle:n,target:r,displayText:`#${r}`})}),i?.headings&&i.headings.forEach(s=>{this.addToIndex(s.heading,{type:"heading",notePath:e,noteTitle:n,target:s.heading,displayText:`${n} > ${s.heading}`})}),i?.sections&&i.sections.forEach(s=>{s.id&&this.addToIndex(s.id,{type:"block",notePath:e,noteTitle:n,target:s.id,displayText:`${n} > #${s.id}`})})}addToIndex(t,n){let e=this.normalizeText(t),i=this.index.get(e)||[];i.some(s=>s.type===n.type&&s.notePath===n.notePath&&s.target===n.target)||i.push(n),this.index.set(e,i)}debouncedIndexUpdate(t){this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=window.setTimeout(()=>{this.deleteFromIndex(t),this.indexFile(t)},300)}getSuggestions(t){let n=this.normalizeText(t);if(!n)return[];let e=[];for(let[o,g]of this.index.entries())o.startsWith(n)&&e.push(...g.map(d=>({...d,score:0})));let i=[];for(let[o,g]of this.index.entries())$(n,o)&&i.push(...g.map(d=>({...d,score:.5})));return[...e,...i].filter((o,g,d)=>g===d.findIndex(c=>c.type===o.type&&c.notePath===o.notePath&&c.target===o.target)).slice(0,100)}},I=class extends u.EditorSuggest{constructor(t){super(t.app);this.plugin=t}onTrigger(t,n){let e=n.getLine(t.line);if(!e)return null;let i=this.getDateTrigger(e,t);if(i)return i;let s=this.getSentenceInfo(e,t.ch);if(!s)return null;let{sentence:r,sentenceOffset:o,wordsWithIndices:g,cursorWordIdx:d}=s;for(let c=g.length;c>=1;c--)for(let x=0;x<=g.length-c;x++){let a=x,y=a+c-1,T=g[a].start,m=g[y].end;if(d<a||d>y)continue;let E=r.substring(T,m);if(this.plugin.getSuggestions(E).length>0)return{start:{line:t.line,ch:o+T},end:{line:t.line,ch:o+m},query:E}}return this.getSingleWordTrigger(e,t)}getDateTrigger(t,n){let e=t.match(/\b\d{4}-\d{2}-\d{2}\b/);if(e){let[i]=e;return{start:{line:n.line,ch:t.indexOf(i)},end:{line:n.line,ch:t.indexOf(i)+i.length},query:i}}return null}getSentenceInfo(t,n){let e=0,i=t.length;for(let a=n-1;a>=0;a--)if(/[.!?]/.test(t[a])){e=a+1;break}for(let a=n;a<t.length;a++)if(/[.!?]/.test(t[a])){i=a;break}for(;e<i&&/\s/.test(t[e]);)e++;for(;i>e&&/\s/.test(t[i-1]);)i--;let s=t.substring(e,i),r=e,o=[],g=/\b\w[\w\p{L}\p{N}'-]*\b/gu,d;for(;(d=g.exec(s))!==null;)o.push({word:d[0],start:d.index,end:d.index+d[0].length});let c=n-r,x=o.findIndex(a=>c>=a.start&&c<=a.end);return x===-1&&(x=o.findIndex(a=>c===a.end)),x===-1?null:{sentence:s,sentenceOffset:r,wordsWithIndices:o,cursorWordIdx:x}}getSingleWordTrigger(t,n){let e=n.ch;for(;e>0&&!/[\s\p{P}]/u.test(t.charAt(e-1));)e--;let i=n.ch;for(;i<t.length&&!/[\s\p{P}]/u.test(t.charAt(i));)i++;let s=t.substring(e,i);return s?{start:{line:n.line,ch:e},end:{line:n.line,ch:i},query:s}:null}async getSuggestions(t){return this.plugin.getSuggestions(t.query)}renderSuggestion(t,n){let e=n.createDiv({cls:"smart-autolinker-suggestion"}),i={title:"file-text",heading:"heading",block:"link",tag:"tag"},s=e.createDiv({cls:"smart-autolinker-icon"});(0,u.setIcon)(s,i[t.type]),e.createDiv({cls:"smart-autolinker-text"}).createEl("strong",{text:t.displayText}),e.createEl("small",{text:`${t.type==="tag"?"Tag":t.type} in ${t.noteTitle}`,cls:"smart-autolinker-subtext"})}selectSuggestion(t){if(!this.context)return;let{editor:n,start:e,end:i,query:s}=this.context,r="";switch(t.type){case"title":r=`[[${t.target}|${s}]]`;break;case"heading":r=`[[${t.noteTitle}#${t.target}|${s}]]`;break;case"block":r=`[[${t.noteTitle}#^${t.target}|${s}]]`;break;case"tag":r=`[[${t.target}|${s}]]`;break}n.replaceRange(r,e,i),this.close()}};
