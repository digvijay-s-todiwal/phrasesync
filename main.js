"use strict";var b=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var q=(l,d)=>{for(var t in d)b(l,t,{get:d[t],enumerable:!0})},L=(l,d,t,n)=>{if(d&&typeof d=="object"||typeof d=="function")for(let e of P(d))!z.call(l,e)&&e!==t&&b(l,e,{get:()=>d[e],enumerable:!(n=C(d,e))||n.enumerable});return l};var O=l=>L(b({},"__esModule",{value:!0}),l);var N={};q(N,{default:()=>I});module.exports=O(N);var h=require("obsidian");function A(l,d){let t=l.toLowerCase().split(""),n=d.toLowerCase(),e=0;for(let i of t){let s=n.indexOf(i,e);if(s===-1)return!1;e=s+1}return!0}var I=class extends h.Plugin{constructor(){super(...arguments);this.index=new Map;this.isIndexing=!1}normalizeText(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^\p{L}\p{N}]/gu,"")}async deleteFromIndex(t){for(let[n,e]of this.index.entries()){let i=e.filter(s=>s.notePath!==t.path);i.length>0?this.index.set(n,i):this.index.delete(n)}}renameInIndex(t,n){for(let[e,i]of this.index.entries()){let s=i.map(a=>a.notePath===n?{...a,notePath:t.path,noteTitle:t.basename}:a);this.index.set(e,s)}}async onload(){this.metadataCache=this.app.metadataCache,this.vault=this.app.vault,await this.buildFullIndex(),this.registerEvent(this.metadataCache.on("changed",t=>this.debouncedIndexUpdate(t))),this.registerEvent(this.vault.on("create",t=>{t instanceof h.TFile&&this.debouncedIndexUpdate(t)})),this.registerEvent(this.vault.on("delete",t=>{t instanceof h.TFile&&this.deleteFromIndex(t)})),this.registerEvent(this.vault.on("rename",(t,n)=>{t instanceof h.TFile&&this.renameInIndex(t,n)})),this.registerEditorSuggest(new v(this))}async buildFullIndex(){if(this.isIndexing)return;this.isIndexing=!0,this.index.clear();let t=this.vault.getMarkdownFiles();for(let n of t)await this.indexFile(n);this.isIndexing=!1}async indexFile(t){if(t.extension!=="md")return;let n=t.basename,e=t.path;this.addToIndex(n,{type:"title",notePath:e,noteTitle:n,target:n,displayText:n});let i=this.metadataCache.getFileCache(t);i?.frontmatter?.tags&&(Array.isArray(i.frontmatter.tags)?i.frontmatter.tags:i.frontmatter.tags.split(",").map(a=>a.trim())).forEach(a=>{this.addToIndex(a,{type:"tag",notePath:e,noteTitle:n,target:a,displayText:`#${a}`})}),i?.headings&&i.headings.forEach(s=>{this.addToIndex(s.heading,{type:"heading",notePath:e,noteTitle:n,target:s.heading,displayText:`${n} > ${s.heading}`})}),i?.sections&&i.sections.forEach(s=>{s.id&&this.addToIndex(s.id,{type:"block",notePath:e,noteTitle:n,target:s.id,displayText:`${n} > #${s.id}`})})}addToIndex(t,n){let e=this.normalizeText(t),i=this.index.get(e)||[];i.some(s=>s.type===n.type&&s.notePath===n.notePath&&s.target===n.target)||i.push(n),this.index.set(e,i)}debouncedIndexUpdate(t){this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=window.setTimeout(()=>{this.deleteFromIndex(t),this.indexFile(t)},300)}getSuggestions(t){let n=this.normalizeText(t);if(!n)return[];let e=[];for(let[o,u]of this.index.entries())o.startsWith(n)&&e.push(...u.map(g=>({...g,score:0})));let i=[];for(let[o,u]of this.index.entries())A(n,o)&&i.push(...u.map(g=>({...g,score:.5})));return[...e,...i].filter((o,u,g)=>u===g.findIndex(c=>c.type===o.type&&c.notePath===o.notePath&&c.target===o.target)).slice(0,100)}},v=class extends h.EditorSuggest{constructor(t){super(t.app);this.plugin=t}onTrigger(t,n){let e=n.getLine(t.line);if(!e)return null;let i=e.match(/\b\d{4}-\d{2}-\d{2}\b/);if(i){let[r]=i;return{start:{line:t.line,ch:e.indexOf(r)},end:{line:t.line,ch:e.indexOf(r)+r.length},query:r}}let s=/[.!?]/g,a=0,o=e.length;for(let r=t.ch-1;r>=0;r--)if(/[.!?]/.test(e[r])){a=r+1;break}for(let r=t.ch;r<e.length;r++)if(/[.!?]/.test(e[r])){o=r;break}for(;a<o&&/\s/.test(e[a]);)a++;for(;o>a&&/\s/.test(e[o-1]);)o--;let u=e.substring(a,o),g=a,c=[],S=/\b\w[\w\p{L}\p{N}'-]*\b/gu,x;for(;(x=S.exec(u))!==null;)c.push({word:x[0],start:x.index,end:x.index+x[0].length});let T=t.ch-g,p=c.findIndex(r=>T>=r.start&&T<=r.end);if(p===-1&&(p=c.findIndex(r=>T===r.end)),p===-1)return null;for(let r=c.length;r>=1;r--)for(let E=0;E<=c.length-r;E++){let m=E,k=m+r-1,F=c[m].start,$=c[k].end;if(p<m||p>k)continue;let M=u.substring(F,$);if(this.plugin.getSuggestions(M).length>0)return{start:{line:t.line,ch:g+F},end:{line:t.line,ch:g+$},query:M}}let f=t.ch;for(;f>0&&!/[\s\p{P}]/u.test(e.charAt(f-1));)f--;let y=t.ch;for(;y<e.length&&!/[\s\p{P}]/u.test(e.charAt(y));)y++;let w=e.substring(f,y);return w?{start:{line:t.line,ch:f},end:{line:t.line,ch:y},query:w}:null}async getSuggestions(t){return this.plugin.getSuggestions(t.query)}renderSuggestion(t,n){let e=n.createDiv({cls:"smart-autolinker-suggestion"}),i={title:"file-text",heading:"heading",block:"link",tag:"tag"},s=e.createDiv({cls:"smart-autolinker-icon"});(0,h.setIcon)(s,i[t.type]),e.createDiv({cls:"smart-autolinker-text"}).createEl("strong",{text:t.displayText}),e.createEl("small",{text:`${t.type==="tag"?"Tag":t.type} in ${t.noteTitle}`,cls:"smart-autolinker-subtext"})}selectSuggestion(t){if(!this.context)return;let{editor:n,start:e,end:i,query:s}=this.context;console.log("Inserting link for:",JSON.stringify(t),", at position:",JSON.stringify({start:e,end:i}));let a="";switch(t.type){case"title":a=`[[${t.target}|${s}]]`;break;case"heading":a=`[[${t.noteTitle}#${t.target}|${s}]]`;break;case"block":a=`[[${t.noteTitle}#^${t.target}|${s}]]`;break;case"tag":a=`[[${t.target}|${s}]]`;break}n.replaceRange(a,e,i),this.close()}};
